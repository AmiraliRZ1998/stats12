library(shiny)
generate_ss <- function(){
  df <- readRDS("wvs.rdata")
  df <- df[sample.int(nrow(df), size = round(runif(1, min = 500, max = nrow(df)))), ]
  att <- readRDS("varatt.rdata")
  return(list(
    df = df,
    att = att
  ))
}
generate_cn <- function(){
  mat <- structure(c(1.24052825382229, 0.540610673607387, 0.354540574194474,
                     -0.418224448760752, -0.110157201766084, 0.466215420045441, -0.11948043383773,
                     -0.370317603185061, -0.393499959410176, -0.180688140322514, 0.0684894071020624,
                     0.176816217839622, 0.000782635244126341, -0.00321956338925079,
                     0.540610673607387, 1.04106892458062, 0.441841420837874, 0.306623788337702,
                     -0.330595674515179, -0.144718519012785, -0.0936861846956196,
                     -0.182265141187823, -0.20161078395035, -0.352112030741094, 0.113020575582962,
                     0.209579831702855, -0.000323394790083759, 0.00133036434819877,
                     0.354540574194474, 0.441841420837874, 1.06543957021052, 0.714753970811323,
                     -0.425997977878528, -0.0202180308282105, -0.289407024543535,
                     -0.355482322054864, -0.329902381574614, -0.145289050831879, 0.0464359094020067,
                     0.142092648657975, -0.000408222156598238, 0.00167932267289203,
                     -0.418224448760752, 0.306623788337702, 0.714753970811323, 1.16926646816891,
                     -0.158187625213991, -0.0522298716706525, -0.163119542731185,
                     -0.15509988410879, -0.115825266403335, -0.135410721491494, 0.0235662371787153,
                     0.110551473728091, 0.000656540949602986, -0.00270084336317399,
                     -0.110157201766084, -0.330595674515179, -0.425997977878528, -0.158187625213991,
                     1.01032853403412, 0.57227686371696, -0.138181222665062, -0.0638491485730985,
                     -0.164147493089818, 0.346074067952301, 0.0934703054529341, -0.00480419432212636,
                     0.000162179402669701, -0.000667165031532492, 0.466215420045441,
                     -0.144718519012785, -0.0202180308282105, -0.0522298716706525,
                     0.57227686371696, 1.0744125114132, -0.108040529800258, -0.166509688023466,
                     -0.0425501980013655, 0.0936964080630921, 0.0575265525782534,
                     0.0128950848351599, -0.000435310692222213, 0.00179075805510869,
                     -0.11948043383773, -0.0936861846956196, -0.289407024543535, -0.163119542731185,
                     -0.138181222665062, -0.108040529800258, 1.00648033871841, 0.345127916158406,
                     0.507443243555408, -0.224811263693005, -0.194827834911217, 0.00380539791959295,
                     -0.000128462156219641, 0.10052846079513, -0.370317603185061,
                     -0.182265141187823, -0.355482322054864, -0.15509988410879, -0.0638491485730985,
                     -0.166509688023466, 0.345127916158406, 1.00366295637123, 0.489440488422261,
                     -0.18638276946564, 0.296111434665776, -0.002860994982591, 9.65811177076004e-05,
                     0.0996026897080804, -0.393499959410176, -0.20161078395035, -0.329902381574614,
                     -0.115825266403335, -0.164147493089818, -0.0425501980013655,
                     0.507443243555408, 0.489440488422261, 1.02433084378959, -0.260677360205115,
                     0.189978052765449, -0.00737360396895867, 0.000248917218378459,
                     0.0989760174844177, -0.180688140322514, -0.352112030741094, -0.145289050831879,
                     -0.135410721491494, 0.346074067952301, 0.0936964080630921, -0.224811263693005,
                     -0.18638276946564, -0.260677360205115, 1.00357207511796, -0.00384002288744572,
                     -0.00282528012801318, 9.53754600275544e-05, 0.0496076494830975,
                     0.0684894071020624, 0.113020575582962, 0.0464359094020067, 0.0235662371787153,
                     0.0934703054529341, 0.0575265525782534, -0.194827834911217, 0.296111434665776,
                     0.189978052765449, -0.00384002288744572, 1.00412806952211, 0.00303720932501062,
                     -0.000102529739866179, 0.100421781400443, 0.176816217839622,
                     0.209579831702855, 0.142092648657975, 0.110551473728091, -0.00480419432212636,
                     0.0128950848351599, 0.00380539791959295, -0.002860994982591,
                     -0.00737360396895867, -0.00282528012801318, 0.00303720932501062,
                     1.00223461344069, -7.54358099074355e-05, 0.000310323836851852,
                     0.000782635244126341, -0.000323394790083759, -0.000408222156598238,
                     0.000656540949602986, 0.000162179402669701, -0.000435310692222213,
                     -0.000128462156219641, 9.65811177076004e-05, 0.000248917218378459,
                     9.53754600275544e-05, -0.000102529739866179, -7.54358099074355e-05,
                     1.0000025465527, 0.399989524125558, -0.00321956338925079, 0.00133036434819877,
                     0.00167932267289203, -0.00270084336317399, -0.000667165031532492,
                     0.00179075805510869, 0.10052846079513, 0.0996026897080804, 0.0989760174844177,
                     0.0496076494830975, 0.100421781400443, 0.000310323836851852,
                     0.399989524125558, 1.00004309509337), dim = c(14L, 14L), dimnames = list(
                       c("LSTS", "RSTS", "LIPL", "RIPL", "mPFC", "LTPJ", "Contagion",
                         "Understanding", "Support", "Age", "Sex", "Situation", "SitxFocus",
                         "Coins"), c("LSTS", "RSTS", "LIPL", "RIPL", "mPFC", "LTPJ",
                                     "Contagion", "Understanding", "Support", "Age", "Sex", "Situation",
                                     "SitxFocus", "Coins")))


  df <- data.frame(mvtnorm::rmvnorm(sigma = mat, n = 32))
  names(df) <- rownames(mat)
  df$Sex <- cut(df$Sex, 2)
  levels(df$Sex) <- c("Male", "Female")
  df$Situation <- cut(df$Situation, 2)
  levels(df$Situation) <- c("Positive", "Negative")
  df$Focus <- "A"
  df$SitxFocus <- as.integer(cut(df$SitxFocus, 2))-1
  df$Focus[df$Situation == "Positive"] <- sample(c("A", "B"), size = length(df$Focus[df$Situation == "Positive"]), replace = TRUE)

  df$Focus[df$Situation == "Negative"] <- c("A", "B")[df$SitxFocus[df$Situation == "Negative"]+1]
  df[["SitxFocus"]] <- NULL
  df[c("Contagion", "Understanding", "Support")] <- lapply(df[c("Contagion", "Understanding", "Support")], cut, breaks = 6, labels = 1:6)
  df$Age <- scales::rescale(df$Age, to = c(runif(1, 9, 11), runif(1, 18, 22)))

  df$Coins <- cut(df$Coins, 4, labels = c("Very unfair", "Unfair", "Fair", "Prosocial"))
  for(j in seq_along(df)){
    ids <- sample.int(nrow(df), size = ceiling(runif(1, 0, ceiling(.01*nrow(df)))))
    if(length(ids) > 0){
      df[[j]][ids] <- NA
    }
  }
  return(list(
    df = df,
    att = NULL
  ))
}

generate_be <- function(){
  mat <- structure(c(1, -0.0772596791368265, -0.0513033316409472, -0.100813654965057,
                     0.00183586505587424, -0.0530010662316357, 0.0703635129431815,
                     0.0605095734068591, 0.135198708695928, -0.00299657038539655,
                     -0.0333230299719713, -0.216989580995251, 0.116709362359178, 0.159234867994037,
                     -0.0362814454894146, 0.231409523686759, 0.0362572403356682, -0.203958288782589,
                     -0.0772596791368265, 1, -0.185673289155814, 0.144099988753784,
                     -0.0963192813152934, 0.0656714706014837, 0.333911387424415, 0.245484138161324,
                     0.218794426543224, -0.0799227365151199, -0.396944915180232, -0.223589546119375,
                     0.0713391488769117, 0.365244364285106, 0.116064968221063, -0.233206522460711,
                     0.0414542012009224, -0.0853808720875326, -0.0513033316409472,
                     -0.185673289155814, 1, 0.295442884856628, 0.090946942206038,
                     -0.0779116171065722, -0.189928242277149, -0.252100199471612,
                     0.0512498294797334, 0.229609981813228, 0.0720994310409961, 0.138717433743569,
                     0.163948534403076, -0.116999391857577, 0.106274703630593, 0.108990410738334,
                     0.139434824469035, -0.111406108148735, -0.100813654965057, 0.144099988753784,
                     0.295442884856628, 1, -0.0612370374988726, 0.141799859211139,
                     0.0388016529693891, -0.0721148954864722, -0.0289224526246183,
                     0.0263723578251897, -0.0411131087292551, 0.096402562441796, 0.116139550810124,
                     -0.0431514491012205, 0.0527601955506291, -0.0518051493691127,
                     0.0940728355593806, -0.00471026194489299, 0.00183586505587424,
                     -0.0963192813152934, 0.090946942206038, -0.0612370374988726,
                     1, -0.0878658736172664, -0.11371294673236, -0.0903040336231853,
                     -0.0103106061989062, 0.0806408906706369, 0.0676935377504318,
                     0.0524145026708754, 0.00543954239732561, -0.0798078003414887,
                     0.0610702497026618, 0.11711237455813, 0.0977728724684084, -0.0557387046387457,
                     -0.0530010662316357, 0.0656714706014837, -0.0779116171065722,
                     0.141799859211139, -0.0878658736172664, 1, 0.104554999315739,
                     0.0926281607286268, 0.0136769457392507, -0.111484495205319, -0.0910380133683188,
                     -0.0339334338693819, 0.0619229718282716, -0.00324622859604324,
                     0.00353246818849133, -0.0588990647643346, 0.0053983012547245,
                     0.117738313480662, 0.0703635129431815, 0.333911387424415, -0.189928242277149,
                     0.0388016529693891, -0.11371294673236, 0.104554999315739, 1,
                     0.285389386956775, 0.11178395632973, -0.277154984056105, -0.479613847245641,
                     -0.350552056135656, -0.0105790083389424, 0.306140272159206, 0.00662020095500839,
                     -0.0212634864985911, -0.0586066279845872, -0.0456141093038986,
                     0.0605095734068591, 0.245484138161324, -0.252100199471612, -0.0721148954864722,
                     -0.0903040336231853, 0.0926281607286268, 0.285389386956775, 1,
                     0.0215111994535645, -0.521348727472531, -0.583400817985768, -0.486051769660502,
                     -0.220024615021748, 0.297666716124886, -0.117481340780124, -0.072087706029961,
                     -0.123217610593489, 0.0278232498147087, 0.135198708695928, 0.218794426543224,
                     0.0512498294797334, -0.0289224526246183, -0.0103106061989062,
                     0.0136769457392507, 0.11178395632973, 0.0215111994535645, 1,
                     0.0264309762820823, -0.329536333256504, -0.573526703576306, 0.176034533849933,
                     0.323187399681534, 0.26182897454634, 0.0760287938871808, 0.179724199407606,
                     -0.206903436340502, -0.00299657038539655, -0.0799227365151199,
                     0.229609981813228, 0.0263723578251897, 0.0806408906706369, -0.111484495205319,
                     -0.277154984056105, -0.521348727472531, 0.0264309762820823, 1,
                     0.247049355143106, 0.00448026194986833, 0.159888126152052, -0.0944797656104346,
                     0.0934335410973589, 0.00942736978300289, 0.102251527675634, -0.103880664774597,
                     -0.0333230299719713, -0.396944915180232, 0.0720994310409961,
                     -0.0411131087292551, 0.0676935377504318, -0.0910380133683188,
                     -0.479613847245641, -0.583400817985768, -0.329536333256504, 0.247049355143106,
                     1, 0.248808617648916, 0.0808246169155079, -0.420954435425544,
                     -0.0822630754580691, 0.0307981952739347, 0.00760235739252695,
                     0.0839246524255871, -0.216989580995251, -0.223589546119375, 0.138717433743569,
                     0.096402562441796, 0.0524145026708754, -0.0339334338693819, -0.350552056135656,
                     -0.486051769660502, -0.573526703576306, 0.00448026194986833,
                     0.248808617648916, 1, -0.0424710254151695, -0.344710574947774,
                     -0.0356419428225965, -0.00574224668050839, -0.0384748225036452,
                     0.143161344658018, 0.116709362359178, 0.0713391488769117, 0.163948534403076,
                     0.116139550810124, 0.00543954239732561, 0.0619229718282716, -0.0105790083389424,
                     -0.220024615021748, 0.176034533849933, 0.159888126152052, 0.0808246169155079,
                     -0.0424710254151695, 1, 1.3043322635743e-16, 0.310169783339752,
                     0.0154839251800857, 0.230417355941022, -0.152232439952446, 0.159234867994037,
                     0.365244364285106, -0.116999391857577, -0.0431514491012205, -0.0798078003414887,
                     -0.00324622859604324, 0.306140272159206, 0.297666716124886, 0.323187399681534,
                     -0.0944797656104346, -0.420954435425544, -0.344710574947774,
                     1.3043322635743e-16, 1, 0.180157842576763, 0.0604740172151537,
                     0.0793327205607223, -0.259675881979973, -0.0362814454894146,
                     0.116064968221063, 0.106274703630593, 0.0527601955506291, 0.0610702497026618,
                     0.00353246818849133, 0.00662020095500839, -0.117481340780124,
                     0.26182897454634, 0.0934335410973589, -0.0822630754580691, -0.0356419428225965,
                     0.310169783339752, 0.180157842576763, 1, 0.00038262443757625,
                     0.344560818380735, -0.168717719774967, 0.231409523686759, -0.233206522460711,
                     0.108990410738334, -0.0518051493691127, 0.11711237455813, -0.0588990647643346,
                     -0.0212634864985911, -0.072087706029961, 0.0760287938871808,
                     0.00942736978300289, 0.0307981952739347, -0.00574224668050839,
                     0.0154839251800857, 0.0604740172151537, 0.00038262443757625,
                     1, 0.0517820845915558, -0.402837764943126, 0.0362572403356682,
                     0.0414542012009224, 0.139434824469035, 0.0940728355593806, 0.0977728724684084,
                     0.0053983012547245, -0.0586066279845872, -0.123217610593489,
                     0.179724199407606, 0.102251527675634, 0.00760235739252695, -0.0384748225036452,
                     0.230417355941022, 0.0793327205607223, 0.344560818380735, 0.0517820845915558,
                     1, -0.146258588253961, -0.203958288782589, -0.0853808720875326,
                     -0.111406108148735, -0.00471026194489299, -0.0557387046387457,
                     0.117738313480662, -0.0456141093038986, 0.0278232498147087, -0.206903436340502,
                     -0.103880664774597, 0.0839246524255871, 0.143161344658018, -0.152232439952446,
                     -0.259675881979973, -0.168717719774967, -0.402837764943126, -0.146258588253961,
                     1), dim = c(18L, 18L), dimnames = list(c("sekse", "lftx", "Edu", "Income", "Urban", "MealsTogether",
                                                              "SEc", "CTc", "UNc", "SDc", "SHc", "APc", "FCax1", "FCax2", "Friendly",
                                                              "Picky", "BuysFR", "Meaty"), c("sekse", "lftx", "Edu", "Income", "Urban", "MealsTogether",
                                                                                             "SEc", "CTc", "UNc", "SDc", "SHc", "APc", "FCax1", "FCax2", "Friendly",
                                                                                             "Picky", "BuysFR", "Meaty")))

  labs = c(sekse = "Sekse", lftx = "Leeftijd in jaren",
           Edu = "Level of education", Income = "In welke klasse valt het bruto jaarlijks inkomen van uw huishouden?",
           Urban = "Urbanized", MealsTogether = "Hoe vaak per week eet u het avondmaal samen met anderen?",
           SEc = "Security", CTc = "Zscore(CTc) conformism / tradition",
           UNc = "Universalism", SDc = "Self direction", SHc = "Zscore(SHc) stimulation / hedonism",
           APc = "Zscore(APc) achievement / power", FCax1 = "Involvement (F 1)",
           FCax2 = "Focus (F 2)", Friendly = "Animal friendly", Picky = "Pickiness",
           BuysFR = "Buys free range", Meaty = "High on meat")

  df <- data.frame(mvtnorm::rmvnorm(sigma = mat, n = sample(500:1600, size = 1)))
  names(df) <- rownames(mat)
  df$sekse <- cut(df$sekse, 2)
  levels(df$sekse) <- c("Male", "Female")

  df$lftx <- scales::rescale(df$lftx, to = c(18, 89))
  df$Edu <- ordered(cut(df$Edu, 5))
  levels(df$Edu) <- 1:5

  df$Income <- ordered(cut(df$Income, 4))
  levels(df$Income) <- 1:4

  df$Urban <- ordered(cut(df$Urban, 5))
  levels(df$Urban) <- 1:5

  df$MealsTogether <- ordered(cut(df$MealsTogether, 9))
  levels(df$MealsTogether) <- 1:9

  df$BuysFR <- cut(df$BuysFR, 2, labels = c("No", "Yes"))

  for(j in seq_along(df)){
    ids <- sample.int(nrow(df), size = ceiling(runif(1, 0, ceiling(.01*nrow(df)))))
    if(length(ids) > 0){
      df[[j]][ids] <- NA
    }
  }

  varatt <- data.frame(
    var = names(df),
    label = labs[names(df)],
    values = "",
    missing = ""
  )
  facs <- sapply(df, inherits, what = "factor")
  varatt$values[facs] <- sapply(names(facs)[facs], function(n){
    lbs <- levels(df[[n]])
    paste0(seq_along(lbs), " = ", lbs, collapse = "; ")
  })
  df[] <- lapply(df, as.numeric)
  return(list(
    df = df,
    att = varatt
  ))
}

ui <- fluidPage(
  h1("Generate synthetic data"),
  p("Select a data source:"),
  selectInput("dataset", "Dataset", choices = c("World Values Survey", "Empathy in Adolescents", "Sustainable Food Choices")),
  p("Enter your group number:"),
  textInput("groupno", "Group name"),
  p("What's your teacher's last name?"),
  textInput("teach", "Teacher's name"),
  #actionButton("create", "Generate data"),
  conditionalPanel(condition = "input.teach == 'Van Lissa'",
                   downloadButton("downloadData", "Download")),
  textOutput("txt1")
)

server <- function(input, output) {
  # The requested dataset
  # data <- reactive({
  #   if(input$teach == "Van Lissa"){
  #     data <- switch(input$dataset,
  #       "World Values Survey" = "wvs",
  #       "Empathy in Adolescents" = "emp",
  #       "Sustainable Food Choices" = "sus",
  #       "First complete the form")
  #
  #   } else {
  #     "First complete the form"
  #   }
  # })
  # output$txt1 <- renderText({
  #   data()
  # })
  output$downloadData <- downloadHandler(
    filename = function() {
      groupno_processed <- tolower(gsub("[^[:alpha:]]", "", input$groupno, ignore.case = TRUE))
      thesd <- sum(match(strsplit(groupno_processed, split = "")[[1]], letters))
      # Use the selected dataset as the suggested file name
      paste0("data_", groupno_processed, "_", c("wvs", "emp", "sfc")[match(input$dataset, c("World Values Survey", "Empathy in Adolescents", "Sustainable Food Choices"))], ".sav")
    },
    content = function(file) {
      groupno_processed <- tolower(gsub("[^[:alpha:]]", "", input$groupno, ignore.case = TRUE))
      thesd <- sum(match(strsplit(groupno_processed, split = "")[[1]], letters))
      set.seed(thesd)
      Args <- switch(input$dataset,
        "World Values Survey" = generate_ss(),
        "Empathy in Adolescents" = generate_cn(),
        "Sustainable Food Choices" = generate_be())
      names(Args) <- c("x", "var.attr")
      Args <- c(list(file = file), Args)
      do.call(misty::write.sav, Args)
    }
  )
}

shinyApp(ui, server)
